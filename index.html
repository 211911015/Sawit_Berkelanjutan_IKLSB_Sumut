<!doctype html>
<html lang="id">
<head>
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="initial-scale=1,user-scalable=no,maximum-scale=1,width=device-width">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  
  <link rel="stylesheet" href="./resources/ol.css">
  <link rel="stylesheet" href="resources/fontawesome-all.min.css">
  <link rel="stylesheet" href="./resources/qgis2web.css">

  <style>
    html, body {
      height: 100%;
      width: 100%;
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif;
      overflow: hidden;
    }
    #app-container {
      display: flex;
      height: 100%;
      width: 100%;
    }
    #sidebar {
      width: 340px;
      flex-shrink: 0;
      background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
      padding: 20px;
      box-shadow: 3px 0 15px rgba(0,0,0,0.1);
      overflow-y: auto;
      z-index: 1000;
    }
    #map {
      flex-grow: 1;
      height: 100%;
    }
    #sidebar h1 {
      font-size: 22px;
      color: #2c3e50;
      margin-top: 0;
      margin-bottom: 25px;
      line-height: 1.3;
      text-align: center;
      font-weight: 600;
      border-bottom: 3px solid #3498db;
      padding-bottom: 15px;
    }
    .legend-section, .search-section {
      margin-bottom: 30px;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .legend-section h2, .search-section h2 {
      font-size: 16px;
      color: #2c3e50;
      border-bottom: 2px solid #e74c3c;
      padding-bottom: 8px;
      margin-bottom: 15px;
      font-weight: 600;
    }
    .legend-item {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      padding: 8px;
      border-radius: 5px;
      transition: background-color 0.2s;
    }
    .legend-item:hover {
      background-color: #f8f9fa;
    }
    .legend-color {
      width: 24px;
      height: 24px;
      margin-right: 12px;
      border: 2px solid #333;
      border-radius: 5px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.3);
    }
    .legend-item span {
      font-weight: 500;
      color: #2c3e50;
    }
    .search-container {
      display: flex;
      gap: 10px;
    }
    #search-input {
      width: 100%;
      padding: 12px;
      font-size: 14px;
      border: 2px solid #bdc3c7;
      border-radius: 8px;
      box-sizing: border-box;
      transition: border-color 0.3s;
    }
    #search-input:focus {
      border-color: #3498db;
      outline: none;
    }
    #btn-reset {
      padding: 12px 16px;
      font-size: 14px;
      border: 2px solid #e74c3c;
      border-radius: 8px;
      background: linear-gradient(135deg, #e74c3c, #c0392b);
      color: white;
      cursor: pointer;
      white-space: nowrap;
      transition: all 0.3s;
      font-weight: 500;
    }
    #btn-reset:hover {
      background: linear-gradient(135deg, #c0392b, #a93226);
      transform: translateY(-1px);
    }

    /* --- STYLE POPUP --- */
    .ol-popup {
      position: absolute;
      background: linear-gradient(135deg, #ffffff 0%, #f8f9fa 100%);
      box-shadow: 0 8px 32px rgba(0,0,0,0.3);
      padding: 20px;
      border-radius: 12px;
      border: 2px solid #3498db;
      min-width: 350px;
      font-size: 13px;
      z-index: 10000;
      pointer-events: auto;
    }
    
    .ol-popup-closer {
      position: absolute;
      top: 10px;
      right: 15px;
      background: #e74c3c;
      border: none;
      font-size: 18px;
      cursor: pointer;
      color: white;
      padding: 5px;
      width: 25px;
      height: 25px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: 50%;
      transition: all 0.3s;
    }
    
    .ol-popup-closer:hover {
      background: #c0392b;
      transform: scale(1.1);
    }
    
    #popup-content h3 {
      margin: 0 0 5px 0;
      font-size: 18px;
      color: #2c3e50;
      padding-right: 35px;
      font-weight: 600;
    }
    #popup-content h4 {
      margin: 0 0 15px 0;
      font-size: 16px;
      color: #27ae60;
      font-weight: 600;
    }
    #popup-content hr {
      border: 0;
      border-top: 2px solid #ecf0f1;
      margin: 15px 0;
    }
    .popup-table { 
      width: 100%; 
      border-spacing: 0; 
      margin-bottom: 15px;
    }
    .popup-table td { 
      padding: 6px 0; 
      vertical-align: top; 
      font-size: 13px;
    }
    .popup-table td:first-child {
      font-weight: 600;
      color: #2c3e50;
      width: 180px;
    }
    .popup-table td:last-child {
      color: #34495e;
    }
    
    .interpretasi {
      margin-top: 20px;
      font-size: 13px;
      line-height: 1.5;
      color: #2c3e50;
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
    }
    .interpretasi h2 {
      font-size: 16px;
      margin-bottom: 15px;
      color: #2c3e50;
      border-bottom: 2px solid #27ae60;
      padding-bottom: 8px;
      font-weight: 600;
    }
    .interpretasi .kategori {
      margin: 12px 0;
      padding: 10px;
      border-left: 4px solid #3498db;
      background: #f8f9fa;
      border-radius: 0 5px 5px 0;
    }
    .interpretasi .kategori strong {
      color: #2c3e50;
      display: block;
      margin-bottom: 5px;
    }

    /* Suitability class indicator */
    .suitability-indicator {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 20px;
      font-weight: 600;
      font-size: 12px;
      margin-left: 8px;
      text-shadow: 0 1px 2px rgba(0,0,0,0.3);
    }
    
    .suitability-s1 { background: linear-gradient(135deg, #2d5016, #3e6b1f); color: white; }
    .suitability-s2 { background: linear-gradient(135deg, #85b66f, #6fa055); color: white; }
    .suitability-s3 { background: linear-gradient(135deg, #fec980, #f4a460); color: #333; }
    .suitability-n { background: linear-gradient(135deg, #ff0900, #cc0700); color: white; }

    /* Responsive */
    @media (max-width: 768px) {
      #sidebar {
        width: 300px;
      }
      .ol-popup { 
        min-width: 280px; 
        font-size: 12px; 
        padding: 15px;
      }
      .popup-table td:first-child { 
        width: 140px; 
        font-size: 12px;
      }
    }

    /* Control styling improvements */
    .ol-control > * {
      background: linear-gradient(135deg, #f8f8f8, #e9ecef) !important;
      color: #2c3e50 !important;
      border-radius: 8px !important;
      border: 1px solid #bdc3c7 !important;
    }
    .ol-control > *:hover {
      background: linear-gradient(135deg, #e9ecef, #dee2e6) !important;
      border-color: #95a5a6 !important;
    }
    .ol-control {
      background-color: rgba(255,255,255,.8) !important;
      padding: 3px !important;
      border-radius: 10px !important;
    }
  </style>
  <title>Peta Kesesuaian Lahan Provinsi Sumatera Utara</title>
</head>
<body>
  <div id="app-container">
    <div id="sidebar">
      <h1>Peta Kesesuaian Lahan Desa/Kelurahan Provinsi Sumatera Utara</h1>

      <div class="search-section">
        <h2>🔍 Cari Kabupaten / Kota</h2>
        <div class="search-container">
          <input type="text" id="search-input" placeholder="Ketik nama kabupaten/kota...">
          <button id="btn-reset" title="Kembali ke tampilan awal Sumatera Utara">Reset</button>
        </div>
      </div>

      <div class="legend-section">
        <h2>🎨 Kelas Kesesuaian Lahan</h2>
        <div class="legend-item">
          <div class="legend-color" style="background: linear-gradient(135deg, #2d5016, #3e6b1f);"></div>
          <span>S1 - Sangat Sesuai</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: linear-gradient(135deg, #85b66f, #6fa055);"></div>
          <span>S2 - Cukup Sesuai</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: linear-gradient(135deg, #fec980, #f4a460);"></div>
          <span>S3 - Sesuai Marjinal</span>
        </div>
        <div class="legend-item">
          <div class="legend-color" style="background: linear-gradient(135deg, #ff0900, #cc0700);"></div>
          <span>N - Tidak Sesuai</span>
        </div>
      </div>

      <div class="interpretasi">
        <h2>📋 Penjelasan Kesesuaian Lahan</h2>
        <div class="kategori">
          <strong>🟢 S1 (Sangat Sesuai)</strong>
          Lahan ini sangat baik untuk pertanian. Tidak ada masalah besar yang menghalangi produktivitas tinggi. Tanaman dapat tumbuh dengan optimal tanpa perlu perlakuan khusus.
        </div>
        <div class="kategori">
          <strong>🟡 S2 (Cukup Sesuai)</strong>
          Lahan masih bagus untuk pertanian, tetapi ada beberapa kendala ringan yang dapat mengurangi hasil panen. Dengan pengelolaan yang tepat, produktivitas masih dapat dipertahankan.
        </div>
        <div class="kategori">
          <strong>🟠 S3 (Sesuai Marjinal)</strong>
          Lahan memiliki kendala yang cukup berat untuk pertanian. Membutuhkan upaya ekstra dan investasi lebih besar untuk mencapai produktivitas yang memadai.
        </div>
        <div class="kategori">
          <strong>🔴 N (Tidak Sesuai)</strong>
          Lahan tidak cocok untuk pertanian karena memiliki kendala yang sangat berat. Sebaiknya digunakan untuk fungsi lain seperti konservasi atau hutan.
        </div>
      </div>
    </div>

    <div id="map">
      <div id="popup" class="ol-popup" style="display: none;">
        <button id="popup-closer" class="ol-popup-closer" aria-label="Tutup popup">×</button>
        <div id="popup-content"></div>
      </div>
    </div>
  </div>

  <!-- Script imports -->
  <script src="resources/qgis2web_expressions.js"></script>
  <script src="./resources/functions.js"></script>
  <script src="./resources/ol.js"></script>
  <script src="./resources/ol-layerswitcher.js"></script>
  
  <!-- Layer scripts -->
  <script src="layers/Toba_1.js"></script>
  <script src="layers/TapanuliUtara_2.js"></script>
  <script src="layers/TapanuliTengah_3.js"></script>
  <script src="layers/TapanuliSelatan_4.js"></script>
  <script src="layers/Simalungun_5.js"></script>
  <script src="layers/SerdangBedagai_6.js"></script>
  <script src="layers/Samosir_7.js"></script>
  <script src="layers/PakpakBarat_8.js"></script>
  <script src="layers/PadangLawasUtara_9.js"></script>
  <script src="layers/PadangLawas_10.js"></script>
  <script src="layers/NiasUtara_11.js"></script>
  <script src="layers/NiasSelatan_12.js"></script>
  <script src="layers/NiasBarat_13.js"></script>
  <script src="layers/Nias_14.js"></script>
  <script src="layers/MandailingNatal_15.js"></script>
  <script src="layers/Langkat_16.js"></script>
  <script src="layers/LabuhanbatuUtara_17.js"></script>
  <script src="layers/LabuhanbatuSelatan_18.js"></script>
  <script src="layers/Labuhanbatu_19.js"></script>
  <script src="layers/KotaTebingTinggi_20.js"></script>
  <script src="layers/KotaTanjungBalai_21.js"></script>
  <script src="layers/KotaSibolga_22.js"></script>
  <script src="layers/KotaPematangSiantar_23.js"></script>
  <script src="layers/KotaPadangSidempuan_24.js"></script>
  <script src="layers/KotaMedan_25.js"></script>
  <script src="layers/KotaGunungsitoli_26.js"></script>
  <script src="layers/KotaBinjai_27.js"></script>
  <script src="layers/Karo_28.js"></script>
  <script src="layers/HumbangHasundutan_29.js"></script>
  <script src="layers/DeliSerdang_30.js"></script>
  <script src="layers/Dairi_31.js"></script>
  <script src="layers/Asahan_32.js"></script>
  <script src="layers/Batubara_33.js"></script>
  <script src="layers/BatasKabupatenSumateraUtara_34.js"></script>
  
  <!-- Style scripts -->
  <script src="styles/Toba_1_style.js"></script>
  <script src="styles/TapanuliUtara_2_style.js"></script>
  <script src="styles/TapanuliTengah_3_style.js"></script>
  <script src="styles/TapanuliSelatan_4_style.js"></script>
  <script src="styles/Simalungun_5_style.js"></script>
  <script src="styles/SerdangBedagai_6_style.js"></script>
  <script src="styles/Samosir_7_style.js"></script>
  <script src="styles/PakpakBarat_8_style.js"></script>
  <script src="styles/PadangLawasUtara_9_style.js"></script>
  <script src="styles/PadangLawas_10_style.js"></script>
  <script src="styles/NiasUtara_11_style.js"></script>
  <script src="styles/NiasSelatan_12_style.js"></script>
  <script src="styles/NiasBarat_13_style.js"></script>
  <script src="styles/Nias_14_style.js"></script>
  <script src="styles/MandailingNatal_15_style.js"></script>
  <script src="styles/Langkat_16_style.js"></script>
  <script src="styles/LabuhanbatuUtara_17_style.js"></script>
  <script src="styles/LabuhanbatuSelatan_18_style.js"></script>
  <script src="styles/Labuhanbatu_19_style.js"></script>
  <script src="styles/KotaTebingTinggi_20_style.js"></script>
  <script src="styles/KotaTanjungBalai_21_style.js"></script>
  <script src="styles/KotaSibolga_22_style.js"></script>
  <script src="styles/KotaPematangSiantar_23_style.js"></script>
  <script src="styles/KotaPadangSidempuan_24_style.js"></script>
  <script src="styles/KotaMedan_25_style.js"></script>
  <script src="styles/KotaGunungsitoli_26_style.js"></script>
  <script src="styles/KotaBinjai_27_style.js"></script>
  <script src="styles/Karo_28_style.js"></script>
  <script src="styles/HumbangHasundutan_29_style.js"></script>
  <script src="styles/DeliSerdang_30_style.js"></script>
  <script src="styles/Dairi_31_style.js"></script>
  <script src="styles/Asahan_32_style.js"></script>
  <script src="styles/Batubara_33_style.js"></script>
  <script src="styles/BatasKabupatenSumateraUtara_34_style.js"></script>
  
  <script src="./layers/layers.js" type="text/javascript"></script>
  <script src="./resources/Autolinker.min.js"></script>
  <script src="./resources/qgis2web.js"></script>
  
  <script>
    function initializeCustomFeatures() {
      console.log("Peta siap. Memulai skrip kustom untuk Sumatera Utara.");

      // Data layer dan style functions untuk semua kabupaten/kota di Sumatera Utara
      const allJsonData = [
        json_Toba_1, json_TapanuliUtara_2, json_TapanuliTengah_3, json_TapanuliSelatan_4, json_Simalungun_5,
        json_SerdangBedagai_6, json_Samosir_7, json_PakpakBarat_8, json_PadangLawasUtara_9, json_PadangLawas_10,
        json_NiasUtara_11, json_NiasSelatan_12, json_NiasBarat_13, json_Nias_14, json_MandailingNatal_15,
        json_Langkat_16, json_LabuhanbatuUtara_17, json_LabuhanbatuSelatan_18, json_Labuhanbatu_19,
        json_KotaTebingTinggi_20, json_KotaTanjungBalai_21, json_KotaSibolga_22, json_KotaPematangSiantar_23,
        json_KotaPadangSidempuan_24, json_KotaMedan_25, json_KotaGunungsitoli_26, json_KotaBinjai_27,
        json_Karo_28, json_HumbangHasundutan_29, json_DeliSerdang_30, json_Dairi_31, json_Asahan_32, json_Batubara_33
      ];
      
      const allStyleFunctions = [
        style_Toba_1, style_TapanuliUtara_2, style_TapanuliTengah_3, style_TapanuliSelatan_4, style_Simalungun_5,
        style_SerdangBedagai_6, style_Samosir_7, style_PakpakBarat_8, style_PadangLawasUtara_9, style_PadangLawas_10,
        style_NiasUtara_11, style_NiasSelatan_12, style_NiasBarat_13, style_Nias_14, style_MandailingNatal_15,
        style_Langkat_16, style_LabuhanbatuUtara_17, style_LabuhanbatuSelatan_18, style_Labuhanbatu_19,
        style_KotaTebingTinggi_20, style_KotaTanjungBalai_21, style_KotaSibolga_22, style_KotaPematangSiantar_23,
        style_KotaPadangSidempuan_24, style_KotaMedan_25, style_KotaGunungsitoli_26, style_KotaBinjai_27,
        style_Karo_28, style_HumbangHasundutan_29, style_DeliSerdang_30, style_Dairi_31, style_Asahan_32, style_Batubara_33
      ];

      // Fungsi untuk menentukan warna berdasarkan suitability class
      function getSuitabilityColor(suitabilityClass) {
        if (!suitabilityClass) {
          return '#cccccc';
        }
        
        const sc = suitabilityClass.toString().trim();
        
        // Pencocokan dengan kategori lengkap
        if (sc === 'S1 - Sangat Sesuai') return '#2d5016';
        if (sc === 'S2 - Cukup Sesuai') return '#85b66f';
        if (sc === 'S3 - Sesuai Marjinal') return '#fec980';
        if (sc === 'N - Tidak Sesuai') return '#ff0900';
        
        // Fallback untuk pencocokan partial case-insensitive
        const scLower = sc.toLowerCase();
        if (scLower.includes('s1') && scLower.includes('sangat sesuai')) return '#2d5016';
        if (scLower.includes('s2') && scLower.includes('cukup sesuai')) return '#85b66f';
        if (scLower.includes('s3') && (scLower.includes('sesuai marjinal') || scLower.includes('sesuai marginal'))) return '#fec980';
        if (scLower.includes('n') && scLower.includes('tidak sesuai')) return '#ff0900';
        
        return '#cccccc';
      }

      // Fungsi style untuk suitability dengan stroke yang lebih tebal untuk desa
      function createSuitabilityStyle(feature) {
        const suitabilityClass = feature.get('Suitabil_1') || feature.get('Suitability_Class') || feature.get('SUITABILITY');
        const fillColor = getSuitabilityColor(suitabilityClass);
        
        return new ol.style.Style({
          fill: new ol.style.Fill({
            color: fillColor
          }),
          stroke: new ol.style.Stroke({
            color: '#2c3e50',
            width: 0.3
          })
        });
      }

      // Style untuk batas kabupaten yang lebih tebal dengan label
      function createKabupatenStyle(feature) {
        const kabupatenName = feature.get('WADMKK') || feature.get('NAMOBJ') || '';
        
        return [
          new ol.style.Style({
            fill: new ol.style.Fill({
              color: 'rgba(0, 0, 0, 0)' // transparan
            }),
            stroke: new ol.style.Stroke({
              color: '#e74c3c',
              width: 3,
              lineDash: [5, 5]
            })
          }),
          new ol.style.Style({
            text: new ol.style.Text({
              text: kabupatenName,
              font: 'bold 12px Arial',
              fill: new ol.style.Fill({
                color: '#2c3e50'
              }),
              stroke: new ol.style.Stroke({
                color: '#ffffff',
                width: 3
              }),
              placement: 'point'
            })
          })
        ];
      }

      // Gabungkan semua features desa dari semua layer
      let allDesaFeatures = [];
      allJsonData.forEach((jsonData, index) => {
        if (typeof jsonData !== 'undefined') {
          const format = new ol.format.GeoJSON();
          const features = format.readFeatures(jsonData, {
            dataProjection: 'EPSG:4326',
            featureProjection: 'EPSG:3857'
          });
          
          features.forEach(feature => {
            feature.set('original_style', allStyleFunctions[index]);
            allDesaFeatures.push(feature);
          });
        }
      });

      // Sembunyikan layer asli kecuali batas kabupaten
      map.getLayers().forEach((layer, index) => {
        const title = layer.get('title');
        if (title && title !== 'BatasKabupatenSumateraUtara') {
          layer.setVisible(false);
        } else if (title === 'BatasKabupatenSumateraUtara') {
          // Ubah style batas kabupaten untuk menampilkan label
          layer.setStyle(createKabupatenStyle);
        }
      });

      // Buat layer gabungan desa dengan style suitability
      const desaSource = new ol.source.Vector({ features: allDesaFeatures });
      const desaLayer = new ol.layer.Vector({
        source: desaSource,
        style: createSuitabilityStyle,
        title: 'Semua Desa/Kelurahan Sumatera Utara'
      });
      
      // Tambahkan layer desa di bawah layer batas kabupaten
      const layers = map.getLayers().getArray();
      const batasKabIndex = layers.findIndex(layer => layer.get('title') === 'BatasKabupatenSumateraUtara');
      if (batasKabIndex >= 0) {
        map.getLayers().insertAt(batasKabIndex, desaLayer);
      } else {
        map.addLayer(desaLayer);
      }
      
      console.log(`Berhasil menggabungkan ${allDesaFeatures.length} desa/kelurahan.`);

      // Fungsi pencarian dan reset
      const searchInput = document.getElementById('search-input');
      const resetButton = document.getElementById('btn-reset');

      function resetMapView() {
        searchInput.value = '';
        desaSource.clear();
        desaSource.addFeatures(allDesaFeatures);
        const ext = desaSource.getExtent();
        if (ext && !isNaN(ext[0])) {
          map.getView().fit(ext, { padding: [50,50,50,50], duration: 500 });
        }
      }

      function searchAndFilter(searchTerm) {
        if (!searchTerm) {
          resetMapView();
          return;
        }
        
        const lowerCaseSearchTerm = searchTerm.toLowerCase();
        const filteredFeatures = allDesaFeatures.filter(feature => {
          const namaKab = (feature.get('WADMKK') || '').toLowerCase();
          return namaKab.includes(lowerCaseSearchTerm);
        });

        desaSource.clear();
        desaSource.addFeatures(filteredFeatures);

        if (filteredFeatures.length > 0) {
          map.getView().fit(desaSource.getExtent(), { 
            padding: [50, 50, 50, 50], 
            maxZoom: 11, 
            duration: 500 
          });
        } else {
          alert('Kabupaten/Kota tidak ditemukan. Silakan cek ejaan atau coba kata kunci lain.');
          resetMapView();
        }
      }

      searchInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter') {
          searchAndFilter(this.value.trim());
        }
      });
      resetButton.addEventListener('click', resetMapView);

      // Setup popup
      const popupContainer = document.getElementById('popup');
      const popupContent = document.getElementById('popup-content');
      const popupCloser = document.getElementById('popup-closer');

      const overlay = new ol.Overlay({
        element: popupContainer,
        autoPan: true,
        autoPanAnimation: { duration: 250 },
        positioning: 'bottom-center',
        offset: [0, -10]
      });
      map.addOverlay(overlay);

      popupCloser.addEventListener('click', function(evt) {
        evt.preventDefault();
        overlay.setPosition(undefined);
        popupContainer.style.display = 'none';
        return false;
      });

      function safeValue(value, decimalPlaces = 2) {
        if (value === null || typeof value === 'undefined' || value === '') return '-';
        if (typeof value === 'number') return value.toFixed(decimalPlaces);
        const num = parseFloat(value);
        if (!isNaN(num)) return num.toFixed(decimalPlaces);
        return value;
      }

      function getSuitabilityLabel(suitabilityClass) {
        if (!suitabilityClass) return 'Tidak Diketahui';
        
        const sc = suitabilityClass.toString().trim();
        
        if (sc === 'S1 - Sangat Sesuai') return 'S1 - Sangat Sesuai';
        if (sc === 'S2 - Cukup Sesuai') return 'S2 - Cukup Sesuai';
        if (sc === 'S3 - Sesuai Marjinal') return 'S3 - Sesuai Marjinal';
        if (sc === 'N - Tidak Sesuai') return 'N - Tidak Sesuai';
        
        const scLower = sc.toLowerCase();
        if (scLower.includes('s1') && scLower.includes('sangat sesuai')) return 'S1 - Sangat Sesuai';
        if (scLower.includes('s2') && scLower.includes('cukup sesuai')) return 'S2 - Cukup Sesuai';
        if (scLower.includes('s3') && (scLower.includes('sesuai marjinal') || scLower.includes('sesuai marginal'))) return 'S3 - Sesuai Marjinal';
        if (scLower.includes('n') && scLower.includes('tidak sesuai')) return 'N - Tidak Sesuai';
        
        return suitabilityClass;
      }

      function getSuitabilityClass(suitabilityClass) {
        if (!suitabilityClass) return '';
        
        const sc = suitabilityClass.toString().trim();
        
        if (sc === 'S1 - Sangat Sesuai') return 'suitability-s1';
        if (sc === 'S2 - Cukup Sesuai') return 'suitability-s2';
        if (sc === 'S3 - Sesuai Marjinal') return 'suitability-s3';
        if (sc === 'N - Tidak Sesuai') return 'suitability-n';
        
        const scLower = sc.toLowerCase();
        if (scLower.includes('s1') && scLower.includes('sangat sesuai')) return 'suitability-s1';
        if (scLower.includes('s2') && scLower.includes('cukup sesuai')) return 'suitability-s2';
        if (scLower.includes('s3') && (scLower.includes('sesuai marjinal') || scLower.includes('sesuai marginal'))) return 'suitability-s3';
        if (scLower.includes('n') && scLower.includes('tidak sesuai')) return 'suitability-n';
        
        return '';
      }

      function formatLimitingFactor(limitingFactor) {
        if (!limitingFactor || limitingFactor === '-') return 'Tidak ada data';
        
        // Mapping faktor pembatas ke bahasa yang lebih mudah dipahami
        const factorMap = {
          'climate': 'Iklim tidak mendukung',
          'soil': 'Kondisi tanah kurang baik',
          'topography': 'Kemiringan lahan terlalu curam',
          'accessibility': 'Akses jalan sulit dijangkau',
          'environment': 'Kondisi lingkungan tidak mendukung',
          'drainage': 'Sistem drainase buruk',
          'slope': 'Kemiringan lahan bermasalah',
          'ph': 'Tingkat keasaman tanah tidak sesuai',
          'rainfall': 'Curah hujan tidak optimal',
          'temperature': 'Suhu tidak sesuai'
        };
        
        const factor = limitingFactor.toString().toLowerCase();
        for (const [key, value] of Object.entries(factorMap)) {
          if (factor.includes(key)) {
            return value;
          }
        }
        
        return limitingFactor; // return original jika tidak ada mapping
      }

      // Hover effect
      let hoveredFeature = null;
      const hoverStyle = new ol.style.Style({
        stroke: new ol.style.Stroke({ 
          color: 'rgba(255, 255, 0, 1.0)', 
          width: 2 
        }),
        fill: new ol.style.Fill({ 
          color: 'rgba(255, 255, 0, 0.3)' 
        })
      });

      map.on('pointermove', function(e) {
        if (e.dragging) return;

        const featureAtPixel = map.forEachFeatureAtPixel(e.pixel, function(f, layer) {
          if (!f) return null;
          if (layer && layer.get && layer.get('title') === 'Semua Desa/Kelurahan Sumatera Utara') return f;
          return null;
        });

        if (hoveredFeature && hoveredFeature !== featureAtPixel) {
          hoveredFeature.setStyle(createSuitabilityStyle(hoveredFeature));
          hoveredFeature = null;
        }
        if (featureAtPixel && featureAtPixel !== hoveredFeature) {
          featureAtPixel.setStyle(hoverStyle);
          hoveredFeature = featureAtPixel;
        }

        map.getTargetElement().style.cursor = hoveredFeature ? 'pointer' : '';
      });

      // Click event untuk popup
      map.on('singleclick', function(evt) {
        const feature = map.forEachFeatureAtPixel(evt.pixel, function(f, layer) {
          if (!f) return null;
          if (layer && layer.get && layer.get('title') === 'Semua Desa/Kelurahan Sumatera Utara') return f;
          return null;
        });

        if (feature) {
          try {
            const props = feature.getProperties();
            const geom = feature.getGeometry();
            const closest = geom.getClosestPoint(evt.coordinate);

            // Ambil data suitability dan limiting factor
            const suitabilityClass = props['Suitabil_1'] || props['Suitability_Class'] || props['SUITABILITY'] || '';
            const suitabilityLabel = getSuitabilityLabel(suitabilityClass);
            const suitabilityClassCSS = getSuitabilityClass(suitabilityClass);
            
            const limitingFactor = props['Limiting_Factor'] || props['LIMITING'] || props['LimitingF'] || props['limiting_factor'] || '';
            const formattedLimitingFactor = formatLimitingFactor(limitingFactor);

            // Emoji berdasarkan kelas suitability
            const emoji = suitabilityClass.includes('S1') ? '🟢' : 
                         suitabilityClass.includes('S2') ? '🟡' : 
                         suitabilityClass.includes('S3') ? '🟠' : 
                         suitabilityClass.includes('N') ? '🔴' : '⚪';

            const content = `
              <h3>${emoji} ${safeValue(props['NAMOBJ'])}</h3>
              <h4><span class="suitability-indicator ${suitabilityClassCSS}">${suitabilityLabel}</span></h4>
              <hr>
              <table class="popup-table">
                <tr><td>📍 Nama Kecamatan</td><td>: ${safeValue(props['WADMKC'])}</td></tr>
                <tr><td>🏛️ Nama Kabupaten/Kota</td><td>: ${safeValue(props['WADMKK'])}</td></tr>
                <tr><td>📏 Luas Wilayah (Ha)</td><td>: ${safeValue(props['LUASWH'], 0)}</td></tr>
                <tr><td>⚠️ Faktor Pembatas</td><td>: ${formattedLimitingFactor}</td></tr>
              </table>
              <hr>
              <strong>📊 Detail Indeks Kesesuaian:</strong>
              <table class="popup-table" style="margin-top: 10px;">
                <tr><td>🌤️ Indeks Iklim</td><td>: ${safeValue(props['Index_Clim'] || props['INDEX_CLIMATE'])}</td></tr>
                <tr><td>🌱 Indeks Tanah</td><td>: ${safeValue(props['Index_Soil'] || props['INDEX_SOIL'])}</td></tr>
                <tr><td>⛰️ Indeks Topografi</td><td>: ${safeValue(props['Index_Topo'] || props['INDEX_TOPOGRAPHY'])}</td></tr>
                <tr><td>🛤️ Indeks Aksesibilitas</td><td>: ${safeValue(props['Index_Acce'] || props['INDEX_ACCESSIBILITY'])}</td></tr>
                <tr><td>🌍 Indeks Lingkungan</td><td>: ${safeValue(props['Index_Envi'] || props['INDEX_ENVIRONMENT'])}</td></tr>
              </table>
            `;

            popupContent.innerHTML = content;
            popupContainer.style.display = 'block';
            overlay.setPosition(closest);

          } catch (err) {
            console.error("Error saat membuat konten popup:", err);
          }
        } else {
          overlay.setPosition(undefined);
          popupContainer.style.display = 'none';
        }
      });

      // Tambahkan kontrol zoom ke posisi awal
      const resetViewControl = document.createElement('div');
      resetViewControl.className = 'ol-control ol-unselectable';
      resetViewControl.style.top = '65px';
      resetViewControl.style.left = '0.5em';
      resetViewControl.innerHTML = '<button title="Kembali ke tampilan awal" style="background: #3498db; color: white; border: none; padding: 5px 8px; border-radius: 3px; cursor: pointer;">🏠</button>';
      
      resetViewControl.addEventListener('click', function() {
        resetMapView();
      });
      
      map.getTargetElement().appendChild(resetViewControl);

    } // end initializeCustomFeatures

    // Tunggu sampai semua variabel dan objek siap
    const mapReadyCheck = setInterval(function() {
      if (typeof map !== 'undefined' && 
          typeof ol !== 'undefined' && 
          typeof json_Toba_1 !== 'undefined' && 
          typeof style_Toba_1 !== 'undefined') {
        clearInterval(mapReadyCheck);
        initializeCustomFeatures();
      }
    }, 100);
  </script>
</body>
</html>
